<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Trajeto com Autocomplete e Geolocalização</title>

    <style>
        /* Estilos básicos para layout e funcionamento */
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden; /* Evita barras de rolagem indesejadas */
        }
        .commutes {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .commutes-map {
            flex-grow: 1; /* O mapa ocupa o espaço restante */
            background-color: #e0e0e0;
        }
        .commutes-info {
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .hide { display: none !important; }

        /* Estilos do modal (simplificados) */
        .commutes-modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .commutes-modal {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
        #destination-address-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .travel-modes { text-align: center; margin-bottom: 15px; }
        .modal-action-bar { text-align: right; }

        /* Estilos para o painel de entrada */
        .description { text-align: center; margin-bottom: 15px; }
        .add-button {
            display: block;
            margin: 0 auto;
            padding: 10px 15px;
            cursor: pointer;
        }
        #results-panel {
            padding: 10px;
            background-color: #f7f7f7;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>

    <svg class="hide">
        <defs>
            <symbol id="commutes-initial-icon">
                <path d="M41 20H18.6c-9.5 0-10.8 13.5 0 13.5h14.5C41 33.5 41 45 33 45H17.7" stroke="#D2E3FC" stroke-width="5"></path>
                <path d="M41 22c.2 0 .4 0 .6-.2l.4-.5c.3-1 .7-1.7 1.1-2.5l2-3c.8-1 1.5-2 2-3 .6-1 .9-2.3.9-3.8 0-2-.7-3.6-2-5-1.4-1.3-3-2-5-2s-3.6.7-5 2c-1.3 1.4-2 3-2 5 0 1.4.3 2.6.8 3.6s1.2 2 2 3.2c.9 1 1.6 2 2 2.8.5.9 1 1.7 1.2 2.7l.4.5.6.2Zm0-10.5c-.7 0-1.3-.2-1.8-.7-.5-.5-.7-1.1-.7-1.8s.2-1.3.7-1.8c.5-.5 1.1-.7 1.8-.7s1.3.2 1.8.7c.5.5.7 1.1.7 1.8s-.2 1.3-.7 1.8c-.5.5-1.1.7-1.8.7Z" fill="#185ABC"></path>
                <path d="m12 32-8 6v12h5v-7h6v7h5V38l-8-6Z" fill="#4285F4"></path>
            </symbol>
            <symbol id="commutes-add-icon"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
            <symbol id="commutes-driving-icon"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></symbol>
            <symbol id="commutes-transit-icon"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h12v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-3.58-4-8-4zm5.66 3H6.43c.61-.52 2.06-1 5.57-1 3.71 0 5.12.46 5.66 1zM11 7v3H6V7h5zm2 0h5v3h-5V7zm3.5 10h-9c-.83 0-1.5-.67-1.5-1.5V12h12v3.5c0 .83-.67 1.5-1.5 1.5z"/><circle cx="8.5" cy="14.5" r="1.5"/><circle cx="15.5" cy="14.5" r="1.5"/></symbol>
            <symbol id="commutes-walking-icon"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.56-.89-1.68-1.25-2.65-.84L6 8.3V13h2V9.6l1.8-.7"/></symbol>
        </defs>
    </svg>

    <main class="commutes">
        <div class="commutes-map" id="map"></div>

        <div class="commutes-info">
            <div id="initial-state">
                <svg aria-label="Directions Icon" width="53" height="53" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <use href="#commutes-initial-icon"/>
                </svg>
                <div class="description">
                    <h1 class="heading">Calcule o tempo de trajeto</h1>
                    <p>Veja o tempo de viagem e rotas para locais de seu interesse.</p>
                </div>
                <button class="add-button" id="open-modal-button">
                    <svg aria-label="Add Icon" width="24px" height="24px" xmlns="http://www.w3.org/2000/svg">
                        <use href="#commutes-add-icon"/>
                    </svg>
                    <span class="label">Adicionar destino</span>
                </button>
            </div>
             <div id="results-panel" class="hide">
                <h2>Detalhes da Rota</h2>
                <div id="directions-panel"></div>
                <button id="new-search-button">Nova Busca</button>
            </div>
        </div>
    </main>

    <div id="modal-container" class="commutes-modal-container hide">
        <div class="commutes-modal" role="dialog" aria-modal="true" aria-labelledby="add-edit-heading">
            <div class="content">
                <h2 id="add-edit-heading" class="heading">Adicionar destino</h2>
                <form id="destination-form" onsubmit="return false;">
                    <input type="text" id="destination-address-input" placeholder="Digite um local ou endereço" autocomplete="off" required>
                    
                    <div class="travel-modes">
                        <input type="radio" name="travel-mode" id="driving-mode" value="DRIVING" checked>
                        <label for="driving-mode" title="Carro">
                            <svg aria-label="Driving icon" width="24" height="24"><use href="#commutes-driving-icon"/></svg>
                        </label>
                        
                        <input type="radio" name="travel-mode" id="transit-mode" value="TRANSIT">
                        <label for="transit-mode" title="Transporte Público">
                            <svg aria-label="Public transit icon" width="24" height="24"><use href="#commutes-transit-icon"/></svg>
                        </label>

                        <input type="radio" name="travel-mode" id="walking-mode" value="WALKING">
                        <label for="walking-mode" title="A pé">
                            <svg aria-label="Walking icon" width="24" height="24"><use href="#commutes-walking-icon"/></svg>
                        </label>
                    </div>
                </form> 
                <div class="modal-action-bar">
                    <button id="cancel-button" class="cancel-button" type="reset">Cancelar</button>
                    <button id="add-destination-button" class="add-destination-button" type="button">Calcular Rota</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let autocomplete;
        let directionsService;
        let directionsRenderer;
        let originLocation; // Armazena a localização de origem (do usuário)
        let destinationPlace; // Armazena o local de destino selecionado no Autocomplete

        function initMap() {
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();

            // Tenta obter a localização do usuário via Geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        originLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        setupMap(originLocation);
                    },
                    () => {
                        // Falha ou permissão negada: usa uma localização padrão (São Luís, MA)
                        handleLocationError(true);
                    }
                );
            } else {
                // Navegador não suporta Geolocation
                handleLocationError(false);
            }
        }

        function handleLocationError(browserHasGeolocation) {
            const defaultLocation = { lat: -2.53073, lng: -44.3068 }; // Coordenadas de São Luís, MA
            originLocation = defaultLocation;
            setupMap(originLocation);
            console.warn(browserHasGeolocation
                ? "Erro: O serviço de geolocalização falhou."
                : "Erro: Seu navegador não suporta geolocalização."
            );
        }

        function setupMap(center) {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: center,
                mapTypeControl: false,
                streetViewControl: false,
            });

            directionsRenderer.setMap(map);
            directionsRenderer.setPanel(document.getElementById("directions-panel"));


            // Marcador para a localização de origem do usuário
            new google.maps.Marker({
                position: center,
                map: map,
                title: "Sua Localização",
            });

            // Configura o Autocomplete no input do modal
            const input = document.getElementById("destination-address-input");
            autocomplete = new google.maps.places.Autocomplete(input, {
                fields: ["place_id", "geometry", "name", "formatted_address"],
            });
            
            // Dá preferência para locais na viewport do mapa
            autocomplete.bindTo("bounds", map);

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry) {
                    destinationPlace = place;
                }
            });

            setupUI();
        }

        function setupUI() {
            const modalContainer = document.getElementById('modal-container');
            const openModalButton = document.getElementById('open-modal-button');
            const cancelButton = document.getElementById('cancel-button');
            const calculateButton = document.getElementById('add-destination-button');
            const newSearchButton = document.getElementById('new-search-button');

            openModalButton.addEventListener('click', () => {
                modalContainer.classList.remove('hide');
            });

            cancelButton.addEventListener('click', () => {
                modalContainer.classList.add('hide');
            });

            calculateButton.addEventListener('click', () => {
                if (!destinationPlace || !destinationPlace.geometry) {
                    alert("Por favor, selecione um destino válido da lista.");
                    return;
                }
                modalContainer.classList.add('hide');
                calculateAndDisplayRoute();
            });
            
            newSearchButton.addEventListener('click', () => {
                document.getElementById('initial-state').classList.remove('hide');
                document.getElementById('results-panel').classList.add('hide');
                directionsRenderer.set('directions', null); // Limpa a rota do mapa
                map.setCenter(originLocation);
                map.setZoom(15);
            });
        }

        function calculateAndDisplayRoute() {
            const selectedMode = document.querySelector('input[name="travel-mode"]:checked').value;
            
            if (!originLocation || !destinationPlace) {
                alert("Não foi possível determinar a origem ou o destino.");
                return;
            }
            
            directionsService.route({
                origin: originLocation,
                destination: { 'placeId': destinationPlace.place_id },
                travelMode: google.maps.TravelMode[selectedMode],
            })
            .then((response) => {
                directionsRenderer.setDirections(response);
                document.getElementById('initial-state').classList.add('hide');
                document.getElementById('results-panel').classList.remove('hide');
            })
            .catch((e) => window.alert("Solicitação de rota falhou: " + e.status));
        }
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCEuKHaxqYCj78yw90FXkwsE3a_ITRqfpA&libraries=places,routes&callback=initMap">
    </script>

</body>
</html>